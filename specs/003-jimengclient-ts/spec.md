# 功能规格说明：从 JimengClient.ts 中提取图像生成代码

**功能分支**: `003-jimengclient-ts`
**创建时间**: 2025-10-01
**状态**: 草稿
**输入**: 用户描述："将图像生成代码从JimengClient.ts里拆出来"

## 执行流程 (main)
```
1. 解析输入的用户描述
   → 识别：从 JimengClient.ts 中提取图像生成功能
2. 提取关键概念
   → 参与者：开发者、代码库维护者
   → 操作：提取、重构、关注点分离
   → 数据：图像生成代码、JimengClient 类
   → 约束：保持向后兼容性、保留所有功能
3. 标记不明确的方面：
   → [已明确：分离意味着创建新的 ImageGenerator 类]
   → [已明确：所有图像生成方法应移至新模块]
4. 填写用户场景和测试部分
   → 用户流程：现有 API 继续完全相同地工作
5. 生成功能需求
   → 每个需求都可通过单元和集成测试进行测试
6. 识别关键实体
   → ImageGenerator 类、JimengClient 委托
7. 运行审查检查清单
   → 规格中无实现细节
   → 所有需求可测试
8. 返回：成功（规格准备好进行规划）
```

---

## ⚡ 快速指南
- ✅ 专注于用户需要什么以及为什么
- ❌ 避免如何实现（无技术栈、API、代码结构）
- 👥 为业务相关方编写，而非开发者

---

## 用户场景与测试

### 主要用户故事
作为使用即梦 MCP SDK 的开发者，我需要将图像生成功能组织在一个专门的模块中，与主客户端类分离，以便代码库更易于维护、测试和扩展。这种分离对现有用户应该是透明的——所有当前的 API 调用必须继续完全相同地工作。

### 验收场景

1. **假设** 现有代码使用 `JimengClient.generateImage()`，**当** 重构完成时，**那么** 所有现有代码无需任何更改即可继续工作
2. **假设** 采用新的模块化结构，**当** 开发者需要修改图像生成逻辑时，**那么** 他们可以在单个专门模块中找到所有相关代码
3. **假设** 重构后的代码库，**当** 运行所有现有测试时，**那么** 100% 的测试无需修改即可通过
4. **假设** 新的结构，**当** 添加新的图像生成功能时，**那么** 可以在专门的图像生成器模块中实现，而无需触及主客户端
5. **假设** 关注点分离，**当** 调试图像生成问题时，**那么** 开发者可以专注于更小、更集中的代码库

### 边界情况

- 当 **异步任务缓存** 在图像生成期间被访问时会发生什么？系统必须在新结构中维护缓存功能
- 当 **继续生成逻辑** 执行时会发生什么？系统必须保留所有多批次生成能力
- 当 **参考图像** 在生成前上传时会发生什么？系统必须维护上传协调
- 当 **现有测试套件** 对重构代码运行时会发生什么？所有测试必须无需修改即可通过
- 当测试 **向后兼容性** 时会发生什么？所有现有公共 API 必须完全相同地工作

---

## 需求

### 功能需求

- **FR-001**: 系统必须保留 `JimengClient` 的所有与图像生成相关的现有公共 API 方法
- **FR-002**: 系统必须与使用 `JimengClient.generateImage()` 的现有代码保持 100% 向后兼容
- **FR-003**: 系统必须将所有图像生成逻辑提取到专门的模块中
- **FR-004**: 系统必须保留所有图像生成能力，包括：
  - 单张和批量图像生成
  - 多参考图支持（最多 4 张图像）
  - 数量 > 4 时的继续生成
  - 异步任务缓存
  - 基于 Draft 和传统轮询
- **FR-005**: 系统必须维护图像生成所需的所有上传和请求构建功能
- **FR-006**: 系统必须通过 `getApiClient()` 保留单例模式以实现向后兼容
- **FR-007**: 系统必须确保所有现有测试无需修改即可通过
- **FR-008**: 系统必须维护委托模式，其中 `JimengClient` 委托给新的图像生成器模块
- **FR-009**: 系统必须保留所有与图像生成相关的私有辅助方法：
  - `buildGenerationRequestData`
  - `buildBlendAbilities`
  - `buildGenerateAbilities`
  - `getReferenceStrength`
  - `performGeneration`
  - `performContinuationGeneration`
  - `performAsyncContinueGeneration`
  - `shouldContinueGeneration`
  - `pollDraftResult`
  - `pollTraditionalResult`
  - `extractImageUrlsFromDraft`
  - `extractImageUrls`
  - `saveRequestLog`
  - `getSessionId`
- **FR-010**: 系统必须将异步任务缓存维护为新模块可访问的静态属性
- **FR-011**: 系统必须确保继续生成逻辑在新结构中工作完全相同
- **FR-012**: 系统必须保留所有日志记录和调试能力

### 关键实体

- **ImageGenerator 模块**：负责所有图像生成操作的新专门模块，包括：
  - 支持继续生成的批量生成
  - 多参考图处理
  - 基于 Draft 和传统结果轮询
  - 为 generate 和 blend 模式构建请求数据
  - 从各种响应格式中提取 URL

- **JimengClient**：维护公共 API 表面并将图像生成操作委托给 ImageGenerator 模块的主客户端类

- **异步任务缓存**：用于跟踪继续生成所需的生成参数的共享状态管理

- **上传协调**：在生成前处理单张和多参考图像上传的机制

---

## 审查和验收检查清单

### 内容质量
- [x] 无实现细节（语言、框架、API）
- [x] 专注于用户价值和业务需求（可维护性、可测试性）
- [x] 为非技术相关方编写
- [x] 所有必填部分已完成

### 需求完整性
- [x] 不再有 [需要澄清] 标记
- [x] 需求可测试且明确
- [x] 成功标准可衡量（100% 测试通过率、向后兼容性）
- [x] 范围明确界定（仅图像生成代码）
- [x] 已识别依赖项和假设（保留现有架构模式）

---

## 执行状态

- [x] 已解析用户描述
- [x] 已提取关键概念
- [x] 已标记模糊之处（并已澄清）
- [x] 已定义用户场景
- [x] 已生成需求
- [x] 已识别实体
- [x] 已通过审查检查清单
