# Research: Generation Status Query Method

**Feature**: 001- Generation Status Query Method
**Date**: 2025-09-30
**Status**: Complete

## Overview

This document consolidates research findings for implementing a query method that allows users to check generation status and retrieve result URLs after initiating image or video generation.

## Key Decisions

### Decision 1: Query Method Implementation Pattern

**Decision**: Implement as NEW wrapper functions that expose existing internal JimengClient methods

**Rationale**:
- ⚠️ **CRITICAL CONSTRAINT**: Cannot modify existing endpoint requests/responses
- Existing codebase already has JimengClient as the unified client (400 lines, extends CreditService)
- Test infrastructure validates async patterns (async-image-generation.test.ts, async-api-integration.test.ts)
- Code analysis shows comprehensive polling mechanism already implemented (pollTraditionalResult method)
- Polling infrastructure already calls `/mweb/v1/get_history_by_ids` - **DO NOT MODIFY**
- Follows established modular pattern: JimengClient → api.ts exports → MCP server tools

**Implementation Approach**:
- **REUSE** existing `pollTraditionalResult()` method (lines 727-910 in JimengClient.ts)
- **ADD** new wrapper methods that call internal polling logic
- **DO NOT** modify existing endpoint URLs, payloads, or response parsing
- **TRANSFORM** responses ONLY in new wrapper layer (status code → user-friendly strings)

**Alternatives Considered**:
1. **Separate QueryService class** - Rejected: Would duplicate polling logic and authentication handling already in JimengClient
2. **Extend ApiClient directly** - Rejected: Breaks established inheritance hierarchy (JimengClient → CreditService → ApiClient)
3. **Standalone query module** - Rejected: Requires duplicating request infrastructure and token management
4. **Modify existing polling method** - **REJECTED: Violates constraint - cannot modify existing endpoint behavior**

### Decision 2: Response Type Design

**Decision**: Use structured response object with discriminated union for status

```typescript
interface QueryResultResponse {
  status: 'pending' | 'processing' | 'completed' | 'failed';
  progress: number;  // 0-100
  imageUrls?: string[];
  videoUrl?: string;
  error?: string;
}
```

**Rationale**:
- Type-safe status handling prevents invalid state combinations
- Progress percentage enables UI progress bars
- Optional fields prevent null/undefined confusion
- Matches existing test patterns (from async-api-integration.test.ts)

**Alternatives Considered**:
1. **Numeric status codes only** - Rejected: Requires users to memorize codes (20/30/42/45/50)
2. **Separate ImageResult/VideoResult types** - Rejected: Adds complexity, status checking is identical
3. **Include raw API response** - Rejected: Leaks implementation details, violates API Contract Stability principle

### Decision 3: Error Handling Strategy

**Decision**: Map internal status codes to descriptive errors with retry logic

**Rationale**:
- Internal codes (20/30/42/45/50) are JiMeng API implementation details
- Users need actionable error messages ("记录不存在", "内容被过滤")
- Existing code has network retry (up to 3 attempts) and timeout (5min) handling
- fail_code '2038' specifically means content filtering

**Alternatives Considered**:
1. **Throw exceptions for all errors** - Rejected: Polling states ('pending', 'processing') aren't errors
2. **Return error codes** - Rejected: Users must maintain code-to-message mappings
3. **Silent failures** - Rejected: Violates user expectation for error visibility

### Decision 4: historyId Format and Validation

**Decision**: Accept string historyId with pattern validation (starts with 'h' + alphanumeric)

**Rationale**:
- Code analysis shows format: `'h' + alphanumeric` (e.g., 'h1234567890abcdef')
- Generated by JiMeng backend, not client-controlled
- Validation prevents malformed requests that waste API calls
- Test suite uses consistent format across 100+ test cases

**Alternatives Considered**:
1. **Accept any string** - Rejected: Allows obviously invalid inputs
2. **UUID format** - Rejected: Not how JiMeng API works
3. **Numeric IDs** - Rejected: Breaks existing API contract

## Technical Findings

### Finding 1: Existing Polling Infrastructure

**Source**: src/api/JimengClient.ts lines 727-910 (pollTraditionalResult method)

**Key Details**:
- Polls JiMeng endpoint `/mweb/v1/get_history_by_ids` with historyId array
- Exponential backoff: 5s → 8s → 10s depending on status code
- Status codes: 20=processing, 30=failed, 42=processing, 45=long-running, 50=completed
- Network error retry: Max 3 attempts
- Total timeout: 5 minutes (300 seconds)
- Returns item_list with image/video URLs when status=50

**Implications**:
- No need to implement new polling logic
- Can reuse existing request infrastructure
- Status code mapping already proven in production use

### Finding 2: Test Coverage Patterns

**Source**: src/__tests__/ directory analysis

**Key Details**:
- `async-image-generation.test.ts`: Unit tests for generateImageAsync, getImageResult
- `async-api-integration.test.ts`: End-to-end workflow tests (submit → poll → retrieve)
- `async-mcp-tools.test.ts`: MCP protocol integration tests
- Mock patterns use jest.fn() for client methods
- Test data formats match proposed QueryResultResponse structure

**Implications**:
- Test infrastructure ready for new functionality
- Follow existing mock/assertion patterns
- Integration tests validate full user workflows

### Finding 3: Authentication Mechanism

**Source**: src/api.ts lines 58-60, src/utils/auth.ts

**Key Details**:
- Uses refresh_token parameter or JIMENG_API_TOKEN environment variable
- Token passed to JimengClient constructor
- Singleton pattern maintains global client instance
- Token validation happens at API client level

**Implications**:
- Query methods must accept optional token parameter
- Fall back to environment variable when not provided
- No separate authentication layer needed

### Finding 4: MCP Tool Integration Pattern

**Source**: src/server.ts (MCP server implementation)

**Key Details**:
- Tools defined with Zod schemas for parameter validation
- Each tool maps to a JimengClient method
- Response formatted as text or structured data
- Error handling converts exceptions to user-friendly messages

**Implications**:
- New query tools follow same pattern
- Zod schema validates historyId format
- Return structured JSON for programmatic access

## Dependencies Analysis

### Existing Dependencies (No Changes)

| Dependency | Version | Purpose | Justification |
|------------|---------|---------|---------------|
| axios | Current | HTTP requests | Used by ApiClient for all API calls |
| zod | Current | Schema validation | MCP tool parameter validation |
| uuid | Current | ID generation | Used in request metadata |
| jest | Current | Testing | Comprehensive test infrastructure |

**Conclusion**: No new dependencies required. All functionality achievable with existing stack.

## Performance Considerations

### Query Latency

**Expected**:
- Typical response: <2 seconds (single API call)
- Worst case: Up to 5 minutes (max timeout for long-running tasks)
- Network errors: 3 retries add up to ~15s overhead

**Mitigation**:
- Client-side caching not needed (stateless queries)
- Concurrent queries via Promise.all (tested in async-api-integration.test.ts)
- User feedback via progress percentage field

### Rate Limiting

**Backend Handling**: JiMeng API enforces rate limits at backend level

**Client Strategy**:
- No artificial throttling (users control query frequency)
- Exponential backoff during polling reduces request rate
- Documentation recommends reasonable poll intervals (5-10s)

## Integration Points

### 1. JimengClient Class

**Location**: src/api/JimengClient.ts

**Changes Required**:
- Add `generateImageAsync(params: ImageGenerationParams): Promise<string>` method
- Add `getImageResult(historyId: string): Promise<QueryResultResponse>` method
- Reuse existing `pollTraditionalResult` for status translation

### 2. Type Definitions

**Location**: src/types/api.types.ts

**Changes Required**:
- Add `QueryResultResponse` interface
- Add `GenerationStatus` type ('pending' | 'processing' | 'completed' | 'failed')

### 3. API Exports

**Location**: src/api.ts

**Changes Required**:
- Export `generateImageAsync` function
- Export `getImageResult` function
- Maintain singleton client pattern

### 4. MCP Server Tools

**Location**: src/server.ts

**Changes Required**:
- Add `generateImageAsync` tool definition with Zod schema
- Add `getImageResult` tool definition with historyId validation
- Follow existing tool response formatting

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| JiMeng API changes historyId format | Low | High | Validate format server-side, graceful fallback to raw API response |
| Status codes change meaning | Low | Medium | Map codes to strings, insulate users from backend changes |
| Polling timeout insufficient for long videos | Medium | Low | Documented behavior, users retry if needed |
| Network errors exceed retry limit | Medium | Low | Clear error messages, users can re-query |

## Open Questions

**RESOLVED**: All questions answered through code analysis

- ✅ historyId format → 'h' + alphanumeric (from test files)
- ✅ Status code meanings → 20/30/42/45/50 mapped (JimengClient.ts:742-744)
- ✅ Authentication mechanism → refresh_token or JIMENG_API_TOKEN (api.ts)
- ✅ Error handling patterns → Descriptive exceptions, network retries (JimengClient.ts)
- ✅ Response structure → {status, progress, URLs, error} (test assertions)

## Conclusion

**Ready for Phase 1 Design**: All technical unknowns resolved. No NEEDS CLARIFICATION markers remain.

**Key Takeaways**:
1. Comprehensive polling infrastructure already exists
2. Test patterns proven and ready for extension
3. Zero new dependencies required
4. Full constitutional compliance (minimal changes, modular extension, backward compatible)

**Next Steps**: Proceed to Phase 1 (data-model.md, contracts, quickstart.md)